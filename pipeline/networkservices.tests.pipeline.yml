parameters:
  # Global flags
  - name: enableProduction
    displayName: "Enable Production"
    type: boolean
    default: false
  - name: drInvocation
    displayName: "Invoke Pipeline DR Operation"
    type: boolean
    default: false

  # Bicep test toggles & settings
  - name: doNotRunBicepTestsResourceGroup
    displayName: "Bicep Tests: Skip Resource Group"
    type: boolean
    default: false
  - name: doNotRunBicepTestsNetworkServices
    displayName: "Bicep Tests: Skip Network Services"
    type: boolean
    default: false
  - name: doNotRunUnit
    displayName: "Bicep Tests: Skip Unit"
    type: boolean
    default: false
  - name: doNotRunIntegration
    displayName: "Bicep Tests: Skip Integration"
    type: boolean
    default: false
  - name: doNotRunRegression
    displayName: "Bicep Tests: Skip Regression"
    type: boolean
    default: false
  - name: doNotRunSmoke
    displayName: "Bicep Tests: Skip Smoke"
    type: boolean
    default: false
  - name: bicepTestsDelayMinutes
    displayName: "Bicep Tests: Delay start (minutes)"
    type: number
    default: 0
    values:
      - 0
      - 5
      - 15
      - 30
      - 45
      - 60

  # Operational flags
  - name: allowDeleteOnUnmanage
    displayName: "Temporarily Allow Delete on Unmanage"
    type: boolean
    default: false
  - name: cleanupResourceGroupStack
    displayName: "Cleanup Resource Group Stack"
    type: boolean
    default: false

  # Environment skips
  - name: skip_dev
    displayName: "Skip Environments: Development"
    type: boolean
    default: false
  - name: skip_qa
    displayName: "Skip Environments: QA"
    type: boolean
    default: true
  - name: skip_ppr
    displayName: "Skip Environments: Pre-Production"
    type: boolean
    default: true

  # Region skips
  - name: skip_primary
    displayName: "Skip Regions: Primary"
    type: boolean
    default: false
  - name: skip_secondary
    displayName: "Skip Regions: Secondary"
    type: boolean
    default: false

extends:
  template: networkservices.settings.yml
  parameters:
    enableProduction: ${{ parameters.enableProduction }}
    runReviewStage: false
    drInvocation: ${{ parameters.drInvocation }}
    skipEnvironments:
      dev: ${{ parameters.skip_dev }}
      qa: ${{ parameters.skip_qa }}
      ppr: ${{ parameters.skip_ppr }}
    skipRegions:
      primary: ${{ parameters.skip_primary }}
      secondary: ${{ parameters.skip_secondary }}
    globalDependsOn: validation
    pipelineType: auto
    actionGroups:
      - name: bicep_tests_resource_group
        enabled: ${{ not(parameters.doNotRunBicepTestsResourceGroup) }}
        type: powershell
        scriptTask: azureCli
        kind: pester
        delayMinutes: ${{ parameters.bicepTestsDelayMinutes }}
        actions:
          - name: unit
            enabled: ${{ not(parameters.doNotRunUnit) }}
            scriptPath: scripts/pester_run.ps1
            arguments: "-TestsPath tests/unit/resource_group -ResultsFile TestResults/bicep_tests_resource_group_unit.xml"
          - name: integration
            enabled: ${{ not(parameters.doNotRunIntegration) }}
            scriptPath: scripts/pester_run.ps1
            arguments: "-TestsPath tests/integration/resource_group -ResultsFile TestResults/bicep_tests_resource_group_integration.xml"
          - name: regression
            enabled: ${{ not(parameters.doNotRunRegression) }}
            scriptPath: scripts/pester_run.ps1
            arguments: "-TestsPath tests/regression/resource_group -ResultsFile TestResults/bicep_tests_resource_group_regression.xml"
          - name: smoke
            enabled: ${{ not(parameters.doNotRunSmoke) }}
            scriptPath: scripts/pester_run.ps1
            arguments: "-TestsPath tests/smoke/resource_group -ResultsFile TestResults/bicep_tests_resource_group_smoke.xml"
      - name: bicep_tests_network_services
        enabled: ${{ not(parameters.doNotRunBicepTestsNetworkServices) }}
        type: powershell
        scriptTask: azureCli
        kind: pester
        delayMinutes: ${{ parameters.bicepTestsDelayMinutes }}
        actions:
          - name: unit
            enabled: ${{ not(parameters.doNotRunUnit) }}
            scriptPath: scripts/pester_run.ps1
            arguments: "-TestsPath tests/unit/resource_group -ResultsFile TestResults/bicep_tests_network_services_unit.xml"
          - name: integration
            enabled: ${{ not(parameters.doNotRunIntegration) }}
            scriptPath: scripts/pester_run.ps1
            arguments: "-TestsPath tests/integration/resource_group -ResultsFile TestResults/bicep_tests_network_services_integration.xml"
          - name: regression
            enabled: ${{ not(parameters.doNotRunRegression) }}
            scriptPath: scripts/pester_run.ps1
            arguments: "-TestsPath tests/regression/network_services -ResultsFile TestResults/bicep_tests_network_services_regression.xml"
          - name: smoke
            enabled: ${{ not(parameters.doNotRunSmoke) }}
            scriptPath: scripts/pester_run.ps1
            arguments: "-TestsPath tests/smoke/network_services -ResultsFile TestResults/bicep_tests_network_services_smoke.xml"
